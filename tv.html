<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1920, initial-scale=1.0, user-scalable=no">
<title>TV Kolam Memancing</title>
<link rel="preconnect" href="https://cdn.tailwindcss.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://www.youtube.com">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase Configuration v2
  const SUPABASE_URL = 'https://wkefbuwkogqjwjhgozid.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrZWZidXdrb2dxandqaGdvemlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjcwODEsImV4cCI6MjA4MzUwMzA4MX0.D7Hy54X4GH5a-i62YgHQNx1nOEctYkR_MYlZijXZuEs';
  
  // Initialize Supabase client
  var supabaseClient;
  
  window.addEventListener('DOMContentLoaded', () => {
    if (window.supabase && window.supabase.createClient) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log('‚úÖ Supabase initialized');
    } else {
      console.error('‚ùå Supabase library not loaded');
    }
  });
</script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          primary: '#a855f7',
          secondary: '#fbbf24',
          dark: '#1e1b4b',
        }
      }
    }
  }
</script>
<style>
  /* Gradient background with image overlay - optimized */
  body {
    background: 
      linear-gradient(135deg, rgba(30, 27, 75, 0.85) 0%, rgba(88, 28, 135, 0.85) 50%, rgba(30, 27, 75, 0.85) 100%),
      url('tes.jpg') center/cover no-repeat fixed;
    background-size: 400% 400%, cover;
    animation: gradientShift 20s ease infinite;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  
  /* Container wrapper for scaling - optimized for TV */
  .tv-container {
    width: 1920px;
    height: 1080px;
    transform-origin: top left;
    transform: scale(0.95); /* Default scale down 5% for better fit */
  }
  
  @media screen and (max-width: 1920px) {
    .tv-container {
      transform: scale(calc(100vw / 1920 * 0.95));
    }
  }
  
  @media screen and (min-width: 1921px) {
    .tv-container {
      transform: scale(calc(100vw / 1920 * 0.9));
    }
  }

  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%, center; }
    50% { background-position: 100% 50%, center; }
  }

  /* Auto-scrolling text for long names */
  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  .scroll-text {
    display: inline-block;
    white-space: nowrap;
    animation: scroll 10s linear infinite;
  }

  .scroll-container {
    overflow: hidden;
    position: relative;
  }

  .scroll-container:hover .scroll-text {
    animation-play-state: paused;
  }
</style>
</head>

<body class="text-white overflow-hidden">

<div class="tv-container">

<!-- Leaderboard + Music Player -->
<div id="mainView" class="h-screen p-5">
  <div class="grid grid-cols-[2.5fr_1fr] gap-5 h-full">

    <!-- LEADERBOARD -->
    <div class="bg-purple-900/30 backdrop-blur-lg rounded-3xl p-10 border border-purple-500/30 shadow-2xl">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-6xl font-bold bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
          üèÜ LEADERBOARD
        </h1>
        <div class="text-right">
          <div class="text-xs opacity-50">Last Updated</div>
          <div id="lastUpdate" class="text-sm font-semibold text-yellow-400">--:--</div>
        </div>
      </div>
      <div id="leaderboard" class="flex flex-col gap-4">
        <div class="text-center py-10 opacity-60">Memuat data...</div>
      </div>
    </div>

    <!-- MUSIC PLAYER -->
    <div class="flex flex-col gap-5">
      <div class="bg-purple-900/30 backdrop-blur-lg rounded-3xl p-6 border border-purple-500/30 shadow-2xl">
        <h3 class="text-xl font-semibold text-yellow-400 mb-4">üéµ NOW PLAYING</h3>
        
        <div id="player" class="rounded-2xl overflow-hidden shadow-xl border-2 border-purple-500/50 mb-4"></div>
        
        <!-- TikTok Follow Section -->
        <div class="bg-purple-900/50 rounded-xl p-4 text-center border border-purple-500/30 mb-4">
          <div class="text-sm opacity-70">Follow us on TikTok</div>
          <div class="text-xl font-bold text-yellow-400">@kolam.udang.lahhh</div>
        </div>
        
        <!-- Logo Outside -->
        <div class="flex justify-center">
          <img src="logo.png" alt="Logo" class="h-28 w-28 object-contain">
        </div>
        
        <p class="text-xs text-center opacity-50 mt-3"></p>
      </div>
    </div>

  </div>
</div>

<!-- Load YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  let player;
  let currentVideo = "";
  let isPlayerReady = false;
  let hasStarted = false;

  // YouTube API ready callback
  function onYouTubeIframeAPIReady() {
    console.log('üé¨ YouTube API ready, waiting for Supabase...');
    
    // Wait for Supabase to be ready
    function initPlayers() {
      if (!supabaseClient) {
        setTimeout(initPlayers, 500);
        return;
      }
      
      console.log('üé¨ Initializing players...');
      
      // Load initial music control from Supabase
      supabaseClient
        .from('music_control')
        .select('*')
        .eq('id', 1)
        .single()
        .then(({ data, error }) => {
          if (error) {
            console.error('Error loading music control:', error);
            // Use defaults if error
            createPlayers(false, 'jNQXAC9IVRw', null);
            return;
          }

          const playlistMode = data?.playlist_mode || false;
          const initialVideo = data?.video_id || "jNQXAC9IVRw";
          const playlistId = data?.playlist_id;
          
          createPlayers(playlistMode, initialVideo, playlistId);
        })
        .catch(err => {
          console.error('Error:', err);
          createPlayers(false, 'jNQXAC9IVRw', null);
        });
    }
    
    initPlayers();
  }

  function createPlayers(playlistMode, initialVideo, playlistId) {
    const playerConfig = {
      height: '240',
      width: '100%',
      playerVars: {
        'autoplay': 1,
        'controls': 1,
        'rel': 0,
        'modestbranding': 1,
        'fs': 1,
        'mute': 1
      },
      events: {
        'onReady': onPlayerReady,
        'onError': onPlayerError,
        'onStateChange': onPlayerStateChange
      }
    };

    // Load playlist or single video
    if (playlistMode && playlistId) {
      playerConfig.playerVars.listType = 'playlist';
      playerConfig.playerVars.list = playlistId;
      console.log("üéµ Loading playlist: " + playlistId);
    } else {
      playerConfig.videoId = initialVideo;
      currentVideo = initialVideo;
      console.log("üéµ Loading video: " + initialVideo);
    }
    
    player = new YT.Player('player', playerConfig);
  }

  function onPlayerReady(event) {
    isPlayerReady = true;
    console.log("‚úÖ Player ready!");
    
    // Auto-start with mute, then unmute after 1 second
    setTimeout(() => {
      player.playVideo();
      setTimeout(() => {
        player.unMute();
        player.setVolume(100);
        hasStarted = true;
        console.log("üé¨ Auto-started with audio!");
      }, 1000);
    }, 500);
  }

  function onPlayerError(event) {
    console.error("‚ùå Player error:", event.data);
  }

  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED && hasStarted) {
      console.log("üîÑ Video ended, playing next...");
    }
    
    // Don't sync position - let each player play independently
    // This prevents the "jump back" issue when switching slides
  }

  // Check for video updates from Supabase (real-time)
  let lastMusicUpdate = null;
  let musicSubscription = null;
  
  // Initialize realtime subscription after Supabase is ready
  function initRealtimeSubscription() {
    if (!supabaseClient) {
      console.log('‚è≥ Waiting for Supabase...');
      setTimeout(initRealtimeSubscription, 500);
      return;
    }

    // Subscribe to real-time changes
    musicSubscription = supabaseClient
      .channel('music_control_changes')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'music_control' },
        (payload) => {
          console.log('üîî Music control updated:', payload);
          handleMusicUpdate(payload.new);
        }
      )
      .subscribe();
    
    console.log('‚úÖ Realtime subscription active');
  }

  // Start subscription when page loads
  window.addEventListener('load', () => {
    setTimeout(initRealtimeSubscription, 1000);
  });

  // Poll for updates (fallback if realtime doesn't work) - optimized interval
  let lastRefreshCheck = null;
  
  setInterval(async () => {
    try {
      const { data, error } = await supabaseClient
        .from('music_control')
        .select('*')
        .eq('id', 1)
        .single();

      if (error) throw error;
      
      // Check for refresh command FIRST (with timestamp to avoid loops)
      if (data && data.refresh_tv === true) {
        const currentCheck = data.updated_at;
        if (currentCheck !== lastRefreshCheck) {
          lastRefreshCheck = currentCheck;
          console.log('üîÑ Hard refresh command detected, clearing cache and reloading...');
          
          // Clear all caches
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => caches.delete(name));
            });
          }
          
          // Clear localStorage (except Supabase config)
          const supabaseUrl = localStorage.getItem('supabase.auth.token');
          localStorage.clear();
          if (supabaseUrl) localStorage.setItem('supabase.auth.token', supabaseUrl);
          
          // Hard reload with cache bypass
          setTimeout(() => {
            window.location.href = window.location.href + '?t=' + Date.now();
          }, 500);
          return;
        }
      }
      
      if (data) handleMusicUpdate(data);
    } catch (err) {
      console.error('Error fetching music control:', err);
    }
  }, 2000); // Check every 2 seconds (was 1 second)

  async function handleMusicUpdate(data) {
    if (!data || !isPlayerReady || !player) return;

    // Handle TV refresh command
    if (data.refresh_tv === true) {
      console.log('üîÑ Refresh command received, reloading page...');
      // Hard reload with cache clear
      window.location.reload(true);
      return;
    }

    // Handle commands
    if (data.command && data.updated_at !== lastMusicUpdate) {
      console.log("üì• Received command: " + data.command);
      
      switch(data.command) {
        case 'play':
          player.playVideo();
          break;
        case 'pause':
          player.pauseVideo();
          break;
        case 'next':
          player.nextVideo();
          break;
        case 'previous':
          player.previousVideo();
          break;
      }
    }

    // Handle video/playlist changes
    if (data.updated_at !== lastMusicUpdate) {
      lastMusicUpdate = data.updated_at;
      
      if (data.playlist_mode && data.playlist_id) {
        console.log("üîÑ Loading playlist: " + data.playlist_id);
        
        player.loadPlaylist({
          listType: 'playlist',
          list: data.playlist_id,
          index: 0
        });
        
        if (hasStarted) {
          setTimeout(() => player.playVideo(), 500);
        }
      } else if (!data.playlist_mode && data.video_id && data.video_id !== currentVideo) {
        console.log("üîÑ Loading video: " + data.video_id);
        currentVideo = data.video_id;
        
        player.loadVideoById(data.video_id);
        
        if (hasStarted) {
          setTimeout(() => player.playVideo(), 500);
        }
      }
    }
  }

  // Load leaderboard
  async function loadLeaderboard() {
    try {
      if (!supabaseClient) {
        console.error('‚ùå Supabase client not ready');
        return;
      }

      const { data: players, error } = await supabaseClient
        .from('players')
        .select('*')
        .order('weight', { ascending: false })
        .limit(10);

      if (error) {
        console.error('Supabase error:', error);
        throw error;
      }

      const board = document.getElementById('leaderboard');
      
      if (!players || players.length === 0) {
        board.innerHTML = '<div class="text-center py-10 opacity-60">Tiada data lagi. Tambah pemain dari Admin Panel.</div>';
        return;
      }
      
      console.log('‚úÖ Loaded ' + players.length + ' players');
      
      // Update timestamp
      const now = new Date();
      const dateStr = now.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
      const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('lastUpdate').textContent = `${dateStr} ${timeStr}`;
      
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const topColors = ['bg-yellow-500/30 border-yellow-500', 'bg-slate-300/30 border-slate-300', 'bg-orange-600/30 border-orange-600'];
      
      board.innerHTML = players.map((p, i) => {
        const isTopThree = i < 3;
        const bgClass = isTopThree ? topColors[i] : 'bg-purple-900/20 border-purple-500/30';
        const isLongName = p.name.length > 15;
        
        return `
          <div class="${bgClass} p-6 rounded-2xl flex items-center gap-5 border-2 transition-all duration-300">
            <div class="text-6xl min-w-[70px]">${medals[i] || 'üé£'}</div>
            <div class="flex-1 ${isLongName ? 'scroll-container' : ''}">
              <div class="text-4xl font-bold mb-2 text-white drop-shadow-lg ${isLongName ? 'scroll-text' : ''}">${isLongName ? p.name + ' ‚Ä¢ ' + p.name : p.name}</div>
              <div class="text-3xl font-bold text-yellow-300 drop-shadow-lg">${p.weight} kg</div>
            </div>
          </div>
        `;
      }).join('');
    } catch (err) {
      console.error('Error loading leaderboard:', err);
      const board = document.getElementById('leaderboard');
      board.innerHTML = '<div class="text-center py-10 text-red-400">Error: ' + err.message + '</div>';
    }
  }

  // Load leaderboard on start and refresh every 10 seconds (optimized)
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (supabaseClient) {
        loadLeaderboard();
        setInterval(loadLeaderboard, 10000);
      } else {
        console.error('‚ùå Supabase not initialized');
      }
    }, 500);
  });

  console.log("üì∫ TV Page loaded");
  console.log("üîó Connected to Supabase");
</script>

</div><!-- End tv-container -->

</body>
</html>
