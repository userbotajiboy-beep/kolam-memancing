<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1920, initial-scale=1.0, user-scalable=no">
<title>TV Kolam Memancing</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase Configuration v2
  const SUPABASE_URL = 'https://wkefbuwkogqjwjhgozid.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrZWZidXdrb2dxandqaGdvemlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjcwODEsImV4cCI6MjA4MzUwMzA4MX0.D7Hy54X4GH5a-i62YgHQNx1nOEctYkR_MYlZijXZuEs';
  
  // Initialize Supabase client
  var supabaseClient;
  
  window.addEventListener('DOMContentLoaded', () => {
    if (window.supabase && window.supabase.createClient) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log('‚úÖ Supabase initialized');
    } else {
      console.error('‚ùå Supabase library not loaded');
    }
  });
</script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          primary: '#a855f7',
          secondary: '#fbbf24',
          dark: '#1e1b4b',
        }
      }
    }
  }
</script>
<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  .animate-slide-in {
    animation: slideIn 0.5s ease forwards;
  }
  
  .slide {
    display: none;
  }
  
  .slide.active {
    display: block;
  }
  
  .fade-transition {
    animation: fadeIn 0.5s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Shining effect for top 3 */
  @keyframes shine {
    0% {
      background-position: -200% center;
    }
    100% {
      background-position: 200% center;
    }
  }

  .shine-gold {
    background: linear-gradient(
      90deg,
      rgba(251, 191, 36, 0.3) 0%,
      rgba(251, 191, 36, 0.8) 50%,
      rgba(251, 191, 36, 0.3) 100%
    );
    background-size: 200% auto;
    animation: shine 3s linear infinite;
    border: 2px solid #fbbf24;
    box-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
  }

  .shine-silver {
    background: linear-gradient(
      90deg,
      rgba(203, 213, 225, 0.3) 0%,
      rgba(203, 213, 225, 0.8) 50%,
      rgba(203, 213, 225, 0.3) 100%
    );
    background-size: 200% auto;
    animation: shine 3s linear infinite;
    animation-delay: 0.5s;
    border: 2px solid #cbd5e1;
    box-shadow: 0 0 30px rgba(203, 213, 225, 0.5);
  }

  .shine-bronze {
    background: linear-gradient(
      90deg,
      rgba(217, 119, 6, 0.3) 0%,
      rgba(217, 119, 6, 0.8) 50%,
      rgba(217, 119, 6, 0.3) 100%
    );
    background-size: 200% auto;
    animation: shine 3s linear infinite;
    animation-delay: 1s;
    border: 2px solid #d97706;
    box-shadow: 0 0 30px rgba(217, 119, 6, 0.5);
  }

  /* Gradient background with image overlay */
  body {
    background: 
      linear-gradient(135deg, rgba(30, 27, 75, 0.85) 0%, rgba(88, 28, 135, 0.85) 50%, rgba(30, 27, 75, 0.85) 100%),
      url('tes.jpg') center/cover no-repeat fixed;
    background-size: 400% 400%, cover;
    animation: gradientShift 15s ease infinite;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  
  /* Container wrapper for scaling */
  .tv-container {
    width: 1920px;
    height: 1080px;
    transform-origin: top left;
  }
  
  @media screen and (max-width: 1920px) {
    .tv-container {
      transform: scale(calc(100vw / 1920));
    }
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%, center; }
    50% { background-position: 100% 50%, center; }
    100% { background-position: 0% 50%, center; }
  }

  /* Auto-scrolling text for long names */
  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  .scroll-text {
    display: inline-block;
    white-space: nowrap;
    animation: scroll 10s linear infinite;
  }

  .scroll-container {
    overflow: hidden;
    position: relative;
  }

  .scroll-container:hover .scroll-text {
    animation-play-state: paused;
  }
</style>
</head>

<body class="text-white overflow-hidden">

<div class="tv-container">

<!-- SLIDE 1: Leaderboard + Music Player -->
<div id="slide1" class="slide active h-screen p-5">
  <div class="grid grid-cols-[2.5fr_1fr] gap-5 h-full">

    <!-- LEADERBOARD -->
    <div class="bg-purple-900/30 backdrop-blur-lg rounded-3xl p-10 border border-purple-500/30 shadow-2xl">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-6xl font-bold bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
          üèÜ LEADERBOARD
        </h1>
        <div class="text-right">
          <div class="text-xs opacity-50">Last Updated</div>
          <div id="lastUpdate" class="text-sm font-semibold text-yellow-400">--:--</div>
        </div>
      </div>
      <div id="leaderboard" class="flex flex-col gap-4">
        <div class="text-center py-10 opacity-60">Memuat data...</div>
      </div>
    </div>

    <!-- MUSIC PLAYER -->
    <div class="flex flex-col gap-5">
      <div class="bg-purple-900/30 backdrop-blur-lg rounded-3xl p-6 border border-purple-500/30 shadow-2xl">
        <h3 class="text-xl font-semibold text-yellow-400 mb-4">üéµ NOW PLAYING</h3>
        
        <div id="player" class="rounded-2xl overflow-hidden shadow-xl border-2 border-purple-500/50 mb-4"></div>
        
        <!-- TikTok Follow Section -->
        <div class="bg-purple-900/50 rounded-xl p-4 text-center border border-purple-500/30 mb-4">
          <div class="text-sm opacity-70">Follow us on TikTok</div>
          <div class="text-xl font-bold text-yellow-400">@kolam.udang.lahhh</div>
        </div>
        
        <!-- Logo Outside -->
        <div class="flex justify-center">
          <img src="logo.png" alt="Logo" class="h-28 w-28 object-contain">
        </div>
        
        <p class="text-xs text-center opacity-50 mt-3"></p>
      </div>
    </div>

  </div>
</div>

<!-- SLIDE 2: Fullscreen Music Player -->
<div id="slide2" class="slide h-screen p-5">
  <div class="h-full flex flex-col items-center justify-center">
    <div class="bg-purple-900/30 backdrop-blur-lg rounded-3xl p-8 border border-purple-500/30 shadow-2xl w-full max-w-5xl">
      <h1 class="text-4xl font-bold text-center bg-gradient-to-r from-yellow-400 via-purple-400 to-yellow-400 bg-clip-text text-transparent mb-6">
        üéµ NOW PLAYING
      </h1>
      <div id="playerFullscreen" class="rounded-2xl overflow-hidden shadow-2xl border-2 border-purple-500/50 mb-5" style="height: 500px;"></div>
      
      <!-- TikTok Follow Section (Fullscreen) -->
      <div class="bg-purple-900/50 rounded-xl p-5 text-center border border-purple-500/30 mb-5">
        <div class="text-base opacity-70">Follow us on TikTok</div>
        <div class="text-2xl font-bold text-yellow-400">@kolam.udang.lahhh</div>
      </div>
      
      <!-- Logo Outside (Fullscreen) -->
      <div class="flex justify-center">
        <img src="logo.png" alt="Logo" class="h-28 w-28 object-contain">
      </div>
    </div>
  </div>
</div>

<!-- Load YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  let player;
  let playerFullscreen;
  let currentVideo = "";
  let isPlayerReady = false;
  let hasStarted = false;
  let currentSlide = 1;
  let slideInterval;

  // Slideshow rotation
  function startSlideshow() {
    slideInterval = setInterval(() => {
      currentSlide = currentSlide === 1 ? 2 : 1;
      showSlide(currentSlide);
    }, 30000); // 30 seconds per slide
  }

  // Keep both players in sync (background sync every 2 seconds)
  setInterval(() => {
    if (!hasStarted || !player || !playerFullscreen) return;
    
    try {
      const activePlayer = currentSlide === 1 ? player : playerFullscreen;
      const inactivePlayer = currentSlide === 1 ? playerFullscreen : player;
      
      const activeState = activePlayer.getPlayerState();
      const inactiveState = inactivePlayer.getPlayerState();
      
      // If active is playing, make sure inactive is also playing (but muted)
      if (activeState === 1 && inactiveState !== 1) {
        const currentTime = activePlayer.getCurrentTime();
        inactivePlayer.seekTo(currentTime, true);
        inactivePlayer.playVideo();
      }
      
      // Sync position if drift is more than 2 seconds
      const timeDiff = Math.abs(activePlayer.getCurrentTime() - inactivePlayer.getCurrentTime());
      if (timeDiff > 2 && activeState === 1) {
        inactivePlayer.seekTo(activePlayer.getCurrentTime(), true);
      }
    } catch(e) {
      // Ignore sync errors
    }
  }, 2000);

  function showSlide(slideNum) {
    document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
    const slide = document.getElementById('slide' + slideNum);
    slide.classList.add('active');
    slide.classList.add('fade-transition');
    
    // Switch audio between players without stopping playback
    if (slideNum === 1) {
      // Switching to Slide 1 - small player active
      if (player && playerFullscreen && hasStarted) {
        try {
          // Get current position from fullscreen player
          const currentTime = playerFullscreen.getCurrentTime();
          const playerState = playerFullscreen.getPlayerState();
          
          // Sync position to small player
          player.seekTo(currentTime, true);
          
          // Ensure small player is playing
          setTimeout(() => {
            player.unMute();
            player.setVolume(100);
            if (playerState === 1) { // If fullscreen was playing
              player.playVideo();
            }
          }, 100);
          
          // Mute fullscreen but keep playing
          playerFullscreen.mute();
          if (playerState === 1) {
            playerFullscreen.playVideo();
          }
        } catch(e) {
          console.log('Sync error:', e);
        }
      }
    } else {
      // Switching to Slide 2 - fullscreen player active
      if (player && playerFullscreen && hasStarted) {
        try {
          // Get current position from small player
          const currentTime = player.getCurrentTime();
          const playerState = player.getPlayerState();
          
          // Sync position to fullscreen player
          playerFullscreen.seekTo(currentTime, true);
          
          // Ensure fullscreen player is playing
          setTimeout(() => {
            playerFullscreen.unMute();
            playerFullscreen.setVolume(100);
            if (playerState === 1) { // If small was playing
              playerFullscreen.playVideo();
            }
          }, 100);
          
          // Mute small but keep playing
          player.mute();
          if (playerState === 1) {
            player.playVideo();
          }
        } catch(e) {
          console.log('Sync error:', e);
        }
      }
    }
    
    console.log('üì∫ Showing slide ' + slideNum);
  }

  function startPlayer() {
    if (player && playerFullscreen && isPlayerReady) {
      // Start both players
      player.unMute();
      player.playVideo();
      
      // Start fullscreen player muted (will unmute when slide 2 shows)
      playerFullscreen.mute();
      playerFullscreen.playVideo();
      
      hasStarted = true;
      
      // Start slideshow after user interaction
      startSlideshow();
      
      console.log("üé¨ Both players started!");
    }
  }

  // YouTube API ready callback
  function onYouTubeIframeAPIReady() {
    console.log('üé¨ YouTube API ready, waiting for Supabase...');
    
    // Wait for Supabase to be ready
    function initPlayers() {
      if (!supabaseClient) {
        setTimeout(initPlayers, 500);
        return;
      }
      
      console.log('üé¨ Initializing players...');
      
      // Load initial music control from Supabase
      supabaseClient
        .from('music_control')
        .select('*')
        .eq('id', 1)
        .single()
        .then(({ data, error }) => {
          if (error) {
            console.error('Error loading music control:', error);
            // Use defaults if error
            createPlayers(false, 'jNQXAC9IVRw', null);
            return;
          }

          const playlistMode = data?.playlist_mode || false;
          const initialVideo = data?.video_id || "jNQXAC9IVRw";
          const playlistId = data?.playlist_id;
          
          createPlayers(playlistMode, initialVideo, playlistId);
        })
        .catch(err => {
          console.error('Error:', err);
          createPlayers(false, 'jNQXAC9IVRw', null);
        });
    }
    
    initPlayers();
  }

  function createPlayers(playlistMode, initialVideo, playlistId) {
    const playerConfig = {
      height: '240',
      width: '100%',
      playerVars: {
        'autoplay': 1,
        'controls': 1,
        'rel': 0,
        'modestbranding': 1,
        'fs': 1,
        'mute': 1
      },
      events: {
        'onReady': onPlayerReady,
        'onError': onPlayerError,
        'onStateChange': onPlayerStateChange
      }
    };

    const playerConfigFullscreen = {
      height: '500',
      width: '100%',
      playerVars: {
        'autoplay': 1,
        'controls': 1,
        'rel': 0,
        'modestbranding': 1,
        'fs': 1,
        'mute': 1
      },
      events: {
        'onReady': onPlayerFullscreenReady,
        'onError': onPlayerError,
        'onStateChange': onPlayerStateChange
      }
    };

    // Load playlist or single video
    if (playlistMode && playlistId) {
      playerConfig.playerVars.listType = 'playlist';
      playerConfig.playerVars.list = playlistId;
      playerConfigFullscreen.playerVars.listType = 'playlist';
      playerConfigFullscreen.playerVars.list = playlistId;
      console.log("üéµ Loading playlist: " + playlistId);
    } else {
      playerConfig.videoId = initialVideo;
      playerConfigFullscreen.videoId = initialVideo;
      currentVideo = initialVideo;
      console.log("üéµ Loading video: " + initialVideo);
    }
    
    player = new YT.Player('player', playerConfig);
    playerFullscreen = new YT.Player('playerFullscreen', playerConfigFullscreen);
  }

  function onPlayerReady(event) {
    isPlayerReady = true;
    console.log("‚úÖ Player ready!");
    
    // Auto-start with mute, then unmute after 1 second
    setTimeout(() => {
      player.playVideo();
      setTimeout(() => {
        player.unMute();
        player.setVolume(100);
        hasStarted = true;
        startSlideshow();
        console.log("üé¨ Auto-started with audio!");
      }, 1000);
    }, 500);
  }

  function onPlayerFullscreenReady(event) {
    console.log("‚úÖ Fullscreen player ready!");
    
    // Auto-start fullscreen player muted
    setTimeout(() => {
      playerFullscreen.playVideo();
      playerFullscreen.mute();
    }, 500);
  }

  function onPlayerError(event) {
    console.error("‚ùå Player error:", event.data);
  }

  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED && hasStarted) {
      console.log("üîÑ Video ended, playing next...");
    }
    
    // Don't sync position - let each player play independently
    // This prevents the "jump back" issue when switching slides
  }

  // Check for video updates from Supabase (real-time)
  let lastMusicUpdate = null;
  let musicSubscription = null;
  
  // Initialize realtime subscription after Supabase is ready
  function initRealtimeSubscription() {
    if (!supabaseClient) {
      console.log('‚è≥ Waiting for Supabase...');
      setTimeout(initRealtimeSubscription, 500);
      return;
    }

    // Subscribe to real-time changes
    musicSubscription = supabaseClient
      .channel('music_control_changes')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'music_control' },
        (payload) => {
          console.log('üîî Music control updated:', payload);
          handleMusicUpdate(payload.new);
        }
      )
      .subscribe();
    
    console.log('‚úÖ Realtime subscription active');
  }

  // Start subscription when page loads
  window.addEventListener('load', () => {
    setTimeout(initRealtimeSubscription, 1000);
  });

  // Poll for updates (fallback if realtime doesn't work)
  let lastRefreshCheck = null;
  
  setInterval(async () => {
    try {
      const { data, error } = await supabaseClient
        .from('music_control')
        .select('*')
        .eq('id', 1)
        .single();

      if (error) throw error;
      
      // Check for refresh command FIRST (with timestamp to avoid loops)
      if (data && data.refresh_tv === true) {
        const currentCheck = data.updated_at;
        if (currentCheck !== lastRefreshCheck) {
          lastRefreshCheck = currentCheck;
          console.log('üîÑ Hard refresh command detected, clearing cache and reloading...');
          
          // Clear all caches
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => caches.delete(name));
            });
          }
          
          // Clear localStorage (except Supabase config)
          const supabaseUrl = localStorage.getItem('supabase.auth.token');
          localStorage.clear();
          if (supabaseUrl) localStorage.setItem('supabase.auth.token', supabaseUrl);
          
          // Hard reload with cache bypass
          setTimeout(() => {
            window.location.href = window.location.href + '?t=' + Date.now();
          }, 500);
          return;
        }
      }
      
      if (data) handleMusicUpdate(data);
    } catch (err) {
      console.error('Error fetching music control:', err);
    }
  }, 1000); // Check every 1 second for faster response

  async function handleMusicUpdate(data) {
    if (!data || !isPlayerReady || !player || !playerFullscreen) return;

    // Handle TV refresh command
    if (data.refresh_tv === true) {
      console.log('üîÑ Refresh command received, reloading page...');
      // Hard reload with cache clear
      window.location.reload(true);
      return;
    }

    // Handle commands
    if (data.command && data.updated_at !== lastMusicUpdate) {
      console.log("üì• Received command: " + data.command);
      
      switch(data.command) {
        case 'play':
          player.playVideo();
          playerFullscreen.playVideo();
          break;
        case 'pause':
          player.pauseVideo();
          playerFullscreen.pauseVideo();
          break;
        case 'next':
          player.nextVideo();
          playerFullscreen.nextVideo();
          break;
        case 'previous':
          player.previousVideo();
          playerFullscreen.previousVideo();
          break;
      }
    }

    // Handle video/playlist changes
    if (data.updated_at !== lastMusicUpdate) {
      lastMusicUpdate = data.updated_at;
      
      if (data.playlist_mode && data.playlist_id) {
        console.log("üîÑ Loading playlist: " + data.playlist_id);
        
        // Load playlist on both players
        player.loadPlaylist({
          listType: 'playlist',
          list: data.playlist_id,
          index: 0
        });
        
        playerFullscreen.loadPlaylist({
          listType: 'playlist',
          list: data.playlist_id,
          index: 0
        });
        
        if (hasStarted) {
          setTimeout(() => {
            player.playVideo();
            playerFullscreen.playVideo();
            // Mute the inactive one
            if (currentSlide === 1) {
              playerFullscreen.mute();
            } else {
              player.mute();
            }
          }, 500);
        }
      } else if (!data.playlist_mode && data.video_id && data.video_id !== currentVideo) {
        console.log("üîÑ Loading video: " + data.video_id);
        currentVideo = data.video_id;
        
        // Load video on both players
        player.loadVideoById(data.video_id);
        playerFullscreen.loadVideoById(data.video_id);
        
        if (hasStarted) {
          setTimeout(() => {
            player.playVideo();
            playerFullscreen.playVideo();
            // Mute the inactive one
            if (currentSlide === 1) {
              playerFullscreen.mute();
            } else {
              player.mute();
            }
          }, 500);
        }
      }
    }
  }

  // Load leaderboard
  async function loadLeaderboard() {
    try {
      if (!supabaseClient) {
        console.error('‚ùå Supabase client not ready');
        return;
      }

      const { data: players, error } = await supabaseClient
        .from('players')
        .select('*')
        .order('weight', { ascending: false })
        .limit(10);

      if (error) {
        console.error('Supabase error:', error);
        throw error;
      }

      const board = document.getElementById('leaderboard');
      
      if (!players || players.length === 0) {
        board.innerHTML = '<div class="text-center py-10 opacity-60">Tiada data lagi. Tambah pemain dari Admin Panel.</div>';
        return;
      }
      
      console.log('‚úÖ Loaded ' + players.length + ' players');
      
      // Update timestamp
      const now = new Date();
      const dateStr = now.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
      const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('lastUpdate').textContent = `${dateStr} ${timeStr}`;
      
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const shineClasses = ['shine-gold', 'shine-silver', 'shine-bronze'];
      
      board.innerHTML = players.map((p, i) => {
        const isTopThree = i < 3;
        const shineClass = isTopThree ? shineClasses[i] : 'bg-purple-900/20';
        const isLongName = p.name.length > 15;
        
        return `
          <div class="${shineClass} p-6 rounded-2xl flex items-center gap-5 border-2 hover:scale-105 transition-all duration-300" style="animation: slideIn 0.5s ease ${i * 0.1}s forwards; opacity: 0;">
            <div class="text-6xl min-w-[70px]">${medals[i] || 'üé£'}</div>
            <div class="flex-1 ${isLongName ? 'scroll-container' : ''}">
              <div class="text-4xl font-bold mb-2 text-white drop-shadow-lg ${isLongName ? 'scroll-text' : ''}">${isLongName ? p.name + ' ‚Ä¢ ' + p.name : p.name}</div>
              <div class="text-3xl font-bold text-yellow-300 drop-shadow-lg">${p.weight} kg</div>
            </div>
          </div>
        `;
      }).join('');
    } catch (err) {
      console.error('Error loading leaderboard:', err);
      const board = document.getElementById('leaderboard');
      board.innerHTML = '<div class="text-center py-10 text-red-400">Error: ' + err.message + '</div>';
    }
  }

  // Load leaderboard on start and refresh every 5 seconds
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (supabaseClient) {
        loadLeaderboard();
        setInterval(loadLeaderboard, 5000);
      } else {
        console.error('‚ùå Supabase not initialized');
      }
    }, 500);
  });

  console.log("üì∫ TV Page loaded");
  console.log("üîó Connected to Supabase");
</script>

</div><!-- End tv-container -->

</body>
</html>
